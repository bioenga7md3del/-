<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø¤Ø´Ø± Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ - 2024/2025</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap');

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #f4f6f9;
            margin: 0;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-radius: 10px;
            overflow-x: auto;
        }

        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            border-bottom: 3px solid #0056b3;
            padding-bottom: 20px;
        }

        .header-text { text-align: right; flex-grow: 1; }
        .logo-container img { max-height: 100px; width: auto; }
        h1 { color: #0056b3; margin: 0; font-size: 24px; font-weight: 700; }
        h2 { color: #555; margin: 5px 0 0 0; font-size: 16px; }

        /* Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… */
        .admin-panel {
            background: #2c3e50;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            border-bottom: 1px solid #34495e;
            padding-bottom: 10px;
        }

        .admin-controls { display: none; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
        
        button {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Tajawal', sans-serif;
            font-weight: bold;
            transition: 0.3s;
            margin-bottom: 5px;
        }

        .btn-login { background: #3498db; color: white; }
        .btn-logout { background: #e74c3c; color: white; }
        .btn-save { background: #27ae60; color: white; }
        .btn-reset { background: #f39c12; color: white; font-size: 12px; }
        .btn-new-month { background: #8e44ad; color: white; border: 1px solid #fff; }
        
        .btn-print { 
            background: #fff; 
            color: #2c3e50; 
            border: 2px solid #bdc3c7;
        }
        .btn-print:hover { background: #ecf0f1; }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1300px;
            margin-top: 10px;
        }

        thead { background-color: #0056b3; color: white; }

        th, td {
            padding: 8px 5px; /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ù‡ÙˆØ§Ù…Ø´ Ù‚Ù„ÙŠÙ„Ø§Ù‹ */
            text-align: center;
            border-bottom: 1px solid #ddd;
            font-size: 14px;
            vertical-align: middle;
        }

        /* ØªØ«Ø¨ÙŠØª Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© */
        th:nth-child(1), td.sticky-col-1 {
            position: sticky; right: 0; background-color: #f9f9f9; z-index: 3; font-weight: bold; border-left: 1px solid #ddd;
        }
        th:nth-child(2), td.sticky-col-2 {
            position: sticky; right: 150px; background-color: #fff; z-index: 2; border-left: 1px solid #ddd;
        }
        th:nth-child(3), td.sticky-col-3 {
            position: sticky; right: 230px; background-color: #f9f9f9; z-index: 2; border-left: 2px solid #999;
        }

        thead th:nth-child(1), thead th:nth-child(2), thead th:nth-child(3) {
            background-color: #004494; color: white; z-index: 4;
        }

        body.editing-mode .editable { border: 2px dashed #3498db; cursor: pointer; background-color: #f0f8ff; }
        body.editing-mode th.editable-header { border: 2px dashed #f1c40f; cursor: pointer; background-color: #2980b9; }

        .status-ok { color: #28a745; font-weight: bold; font-size: 18px; }
        .status-late { color: #dc3545; font-weight: bold; font-size: 18px; }

        .badge {
            display: inline-block; padding: 2px 8px; border-radius: 12px;
            font-size: 12px; font-weight: bold; color: white;
        }
        .badge-red { background-color: #dc3545; }
        .badge-green { background-color: #28a745; }

        .note-text {
            font-size: 11px; color: #444; background: #fff3cd; 
            padding: 4px; border-radius: 4px; max-width: 200px; margin: auto;
        }
        
        /* ØªÙ†Ø³ÙŠÙ‚ Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯ */
        .type-medical { color: #0056b3; font-weight: bold; font-size: 13px; background-color: #e3f2fd; }
        .type-non-medical { color: #d35400; font-weight: bold; font-size: 13px; background-color: #fdebd0; }

        /* ÙØ§ØµÙ„ Ø¨ÙŠÙ† Ø§Ù„Ù…Ø³ØªØ´ÙÙŠØ§Øª */
        .hospital-separator { border-bottom: 2px solid #666 !important; }

        footer {
            margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd;
            text-align: center; font-size: 14px; color: #0056b3; font-weight: bold;
        }
        
        #loader { text-align: center; padding: 20px; font-weight: bold; color: #0056b3; }

        @media print {
            @page { size: landscape; margin: 5mm; }
            body { 
                background-color: white; 
                transform: scale(0.75); /* ØªØµØºÙŠØ± Ø£ÙƒØ«Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„Ø§Ø³ØªÙŠØ¹Ø§Ø¨ Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© */
                transform-origin: top right; 
                width: 133%; 
                -webkit-print-color-adjust: exact !important; 
                print-color-adjust: exact !important; 
            }
            .container { box-shadow: none; margin: 0; padding: 0; width: 100% !important; max-width: none !important; }
            .admin-panel, .btn-print, #loginSection { display: none !important; }
            th, td { border: 1px solid #000 !important; font-size: 11px; padding: 4px !important; color: black !important; }
            .type-medical { background-color: #e3f2fd !important; }
            .type-non-medical { background-color: #fdebd0 !important; }
            a { text-decoration: none; color: black; }
        }
    </style>
</head>
<body>

<div class="container">
    
    <div class="admin-panel">
        <div class="admin-header">
            <div style="font-weight: bold;">ğŸ”’ Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ†</div>
            <button class="btn-print" onclick="window.print()">ğŸ–¨ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± / PDF</button>
        </div>

        <div id="loginSection">
            <button class="btn-login" onclick="adminLogin()">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ (Ø£Ø¯Ù…Ù†)</button>
        </div>

        <div id="adminControls" class="admin-controls">
            <button class="btn-new-month" onclick="addNewMonthAutomatic()">ğŸ“… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø³Ø§Ø¨Ù‚ (Ø¥Ù‚ÙØ§Ù„)</button>
            <button class="btn-save" onclick="saveToFirebase()">â˜ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
            <button class="btn-reset" onclick="uploadInitialData()">âš  Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„ (Ø·Ø¨ÙŠ/ØºÙŠØ± Ø·Ø¨ÙŠ)</button>
            <button class="btn-logout" onclick="location.reload()">Ø®Ø±ÙˆØ¬</button>
            <div style="width: 100%; font-size:12px; color:#bdc3c7; margin-top:5px;">
                Ù„ÙƒÙ„ Ù…Ø³ØªØ´ÙÙ‰ Ø§Ù„Ø¢Ù† ØµÙØ§Ù† Ù…Ø³ØªÙ‚Ù„Ø§Ù† (Ø·Ø¨ÙŠ ÙˆØºÙŠØ± Ø·Ø¨ÙŠ).
            </div>
        </div>
    </div>

    <header>
        <div class="header-text">
            <h1>Ù…Ø¤Ø´Ø± Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ù„Ø±ÙØ¹ Ù…Ø³ØªØ®Ù„ØµØ§Øª Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„Ø·Ø¨ÙŠØ©</h1>
            <h2>Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ© 2024 / 2025</h2>
        </div>
        <div class="logo-container">
            <img src="TabukCluster.jpeg" alt="Ø´Ø¹Ø§Ø± ØªØ¬Ù…Ø¹ ØªØ¨ÙˆÙƒ Ø§Ù„ØµØ­ÙŠ">
        </div>
    </header>

    <div id="loader">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±...</div>

    <table id="mainTable" style="display:none;">
        <thead>
            <tr id="headerRow">
                </tr>
        </thead>
        <tbody id="tableBody">
            </tbody>
    </table>

    <footer>
        ØªÙ… Ø§Ù„Ø§Ø¹Ø¯Ø§Ø¯ Ø¹Ù† Ø·Ø±ÙŠÙ‚ Ù‚Ø³Ù… Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„Ø·Ø¨ÙŠØ© Ø¨ØªØ¬Ù…Ø¹ ØªØ¨ÙˆÙƒ Ø§Ù„ØµØ­ÙŠ
    </footer>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAP-wgrP2o6ifi3XuaMK-lBB43nvrs3GfA",
        authDomain: "tabuk-kpi.firebaseapp.com",
        projectId: "tabuk-kpi",
        storageBucket: "tabuk-kpi.firebasestorage.app",
        messagingSenderId: "537604438384",
        appId: "1:537604438384:web:4391b219241c54f7d6f7b5",
        measurementId: "G-9FCG4452CQ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    
    window.currentData = { monthNames: [], rows: [] };
    window.isAdmin = false;

    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø³Ø§Ø± v4 Ù„Ù„Ù‡ÙŠÙƒÙ„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    const dataRef = ref(db, 'kpi_data_v4'); 
    onValue(dataRef, (snapshot) => {
        const data = snapshot.val();
        const loader = document.getElementById('loader');
        const table = document.getElementById('mainTable');
        
        if (data && data.rows) {
            window.currentData = data;
            renderTable(data);
            loader.style.display = 'none';
            table.style.display = 'table';
        } else {
            loader.innerHTML = "ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ 'Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„' Ù„Ù„Ø¨Ø¯Ø¡.";
        }
    });

    window.saveToFirebase = function() {
        if (!window.isAdmin) return;
        set(ref(db, 'kpi_data_v4'), window.currentData)
            .then(() => { alert("ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­! âœ…"); })
            .catch((error) => { alert("Ø®Ø·Ø£: " + error); });
    };

    window.uploadInitialData = function() {
        if(confirm("ØªØ­Ø°ÙŠØ±: Ø³ÙŠØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø¨ØµÙÙŠÙ† (Ø·Ø¨ÙŠ/ØºÙŠØ± Ø·Ø¨ÙŠ) Ù„ÙƒÙ„ Ù…Ø³ØªØ´ÙÙ‰. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ")) {
            
            // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ´ÙÙŠØ§Øª
            const hospitals = [
                "Ù…Ø³ØªØ´ÙÙ‰ Ø¶Ø¨Ø§ Ø§Ù„Ø¹Ø§Ù…", "Ù…Ø³ØªØ´ÙÙ‰ Ø£Ù…Ù„Ø¬ Ø§Ù„Ø¹Ø§Ù…", "Ù…Ø³ØªØ´ÙÙ‰ Ø­Ù‚Ù„ Ø§Ù„Ø¹Ø§Ù…", 
                "Ù…Ø³ØªØ´ÙÙ‰ Ø§Ù„Ø¨Ø¯Ø¹ Ø§Ù„Ø¹Ø§Ù…", "Ù…Ø³ØªØ´ÙÙ‰ Ø£Ø´ÙˆØ§Ù‚ Ø§Ù„Ø¹Ø§Ù…", "Ù…Ø³ØªØ´ÙÙ‰ ØªÙŠÙ…Ø§Ø¡ Ø§Ù„Ø¹Ø§Ù…", 
                "Ù…Ø³ØªØ´ÙÙ‰ Ø£Ø¨ÙˆØ±Ø§ÙƒØ© Ø§Ù„Ø¹Ø§Ù…", "Ù…Ø³ØªØ´ÙÙ‰ Ø§Ù„Ù…Ù„Ùƒ ÙÙ‡Ø¯", "Ù…Ø³ØªØ´ÙÙ‰ Ø§Ù„ØµØ­Ø© Ø§Ù„Ù†ÙØ³ÙŠØ©", 
                "Ù…Ø³ØªØ´ÙÙ‰ Ø§Ù„Ù…Ù„Ùƒ Ø®Ø§Ù„Ø¯", "Ù…Ø³ØªØ´ÙÙ‰ Ø§Ù„ÙˆÙ„Ø§Ø¯Ø© ÙˆØ§Ù„Ø£Ø·ÙØ§Ù„", "Ù…Ø³ØªØ´ÙÙ‰ Ø§Ù„ÙˆØ¬Ù‡"
            ];

            const emptyMonths = ["âœ”","âœ”","âœ”","âœ”","âœ”","âœ”","âœ”","âœ”","âœ”","âœ”","âœ”","âœ”"];
            
            let newRows = [];
            
            // Ø¥Ù†Ø´Ø§Ø¡ ØµÙÙŠÙ† Ù„ÙƒÙ„ Ù…Ø³ØªØ´ÙÙ‰
            hospitals.forEach(hosp => {
                // Ø§Ù„ØµÙ Ø§Ù„Ø·Ø¨ÙŠ
                newRows.push({
                    name: hosp,
                    type: "Ø·Ø¨ÙŠ",
                    cont: "Ø§Ø³Ù… Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„",
                    late: 0,
                    months: [...emptyMonths],
                    notes: ""
                });
                // Ø§Ù„ØµÙ ØºÙŠØ± Ø§Ù„Ø·Ø¨ÙŠ
                newRows.push({
                    name: hosp, // Ù†ÙØ³ Ø§Ù„Ø§Ø³Ù… Ù„ÙŠØªÙ… Ø¯Ù…Ø¬Ù‡
                    type: "ØºÙŠØ± Ø·Ø¨ÙŠ",
                    cont: "Ø§Ø³Ù… Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„",
                    late: 0,
                    months: [...emptyMonths],
                    notes: ""
                });
            });

            const initialData = {
                monthNames: [
                    "Ø£ÙƒØªÙˆØ¨Ø± 25", "Ø³Ø¨ØªÙ…Ø¨Ø± 25", "Ø£ØºØ³Ø·Ø³ 25", "ÙŠÙˆÙ„ÙŠÙˆ 25", 
                    "ÙŠÙˆÙ†ÙŠÙˆ 25", "Ù…Ø§ÙŠÙˆ 25", "Ø£Ø¨Ø±ÙŠÙ„ 24", "Ù…Ø§Ø±Ø³ 25", 
                    "ÙØ¨Ø±Ø§ÙŠØ± 25", "ÙŠÙ†Ø§ÙŠØ± 25", "Ø¯ÙŠØ³Ù…Ø¨Ø± 24", "Ù†ÙˆÙÙ…Ø¨Ø± 24"
                ],
                rows: newRows
            };
            
            window.currentData = initialData;
            window.saveToFirebase();
        }
    };

    window.addNewMonthAutomatic = function() {
        if (!window.isAdmin) return;

        const date = new Date();
        date.setMonth(date.getMonth() - 1); 
        
        const monthsAr = ["ÙŠÙ†Ø§ÙŠØ±", "ÙØ¨Ø±Ø§ÙŠØ±", "Ù…Ø§Ø±Ø³", "Ø£Ø¨Ø±ÙŠÙ„", "Ù…Ø§ÙŠÙˆ", "ÙŠÙˆÙ†ÙŠÙˆ", "ÙŠÙˆÙ„ÙŠÙˆ", "Ø£ØºØ³Ø·Ø³", "Ø³Ø¨ØªÙ…Ø¨Ø±", "Ø£ÙƒØªÙˆØ¨Ø±", "Ù†ÙˆÙÙ…Ø¨Ø±", "Ø¯ÙŠØ³Ù…Ø¨Ø±"];
        const prevMonthName = monthsAr[date.getMonth()];
        const prevYearShort = date.getFullYear().toString().slice(-2);
        
        const newColumnTitle = `${prevMonthName} ${prevYearShort}`;

        if (window.currentData.monthNames[0] === newColumnTitle) {
            alert(`Ø§Ù„Ø´Ù‡Ø± "${newColumnTitle}" Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„!`);
            return;
        }

        if(!confirm(`Ø¥Ø¶Ø§ÙØ© Ø´Ù‡Ø± Ø¬Ø¯ÙŠØ¯: "${newColumnTitle}" Ù„Ù„Ø¬Ù…ÙŠØ¹ØŸ`)) {
            return;
        }

        window.currentData.monthNames.unshift(newColumnTitle);
        window.currentData.rows.forEach(row => {
            row.months.unshift("âœ˜");
        });

        if (window.currentData.monthNames.length > 12) {
            window.currentData.monthNames.pop();
            window.currentData.rows.forEach(row => {
                row.months.pop();
            });
        }

        renderTable(window.currentData);
        window.saveToFirebase();
    };

</script>

<script>
    function adminLogin() {
        const pass = prompt("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„:");
        if(pass === "1234") {
            window.isAdmin = true;
            document.body.classList.add('editing-mode');
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('adminControls').style.display = 'flex';
            renderTable(window.currentData);
        } else {
            alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©");
        }
    }

    function renderTable(data) {
        const headerRow = document.getElementById('headerRow');
        headerRow.innerHTML = `
            <th style="min-width: 150px;">Ø§Ù„Ù…ÙˆÙ‚Ø¹ / Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰</th>
            <th style="min-width: 80px;">Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯</th>
            <th style="min-width: 140px;">Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„</th>
            <th style="width: 50px;">Ø§Ù„Ù…ØªØ£Ø®Ø±Ø©</th>
        `;

        if(data.monthNames) {
            data.monthNames.forEach((monthName, index) => {
                let style = index === 0 ? "border-bottom: 3px solid #e74c3c;" : "";
                headerRow.innerHTML += `<th class="editable-header" style="${style}" onclick="editHeader(${index})">${monthName}</th>`;
            });
        }

        headerRow.innerHTML += `<th style="min-width: 180px;">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù‡Ø§Ù…Ø©</th>`;

        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';

        if(data.rows) {
            // Ù†Ù‚ÙˆÙ… Ø¨Ø§Ù„Ù…Ø±ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ØµÙÙˆÙ.. ÙˆÙ†Ø­Ø§ÙˆÙ„ Ø¯Ù…Ø¬ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ Ø§Ù„Ù…ØªÙƒØ±Ø±
            let i = 0;
            while (i < data.rows.length) {
                let row = data.rows[i];
                let nextRow = data.rows[i+1];
                
                // Ù‡Ù„ Ø§Ù„ØµÙ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙˆØ§Ù„ØªØ§Ù„ÙŠ Ù„Ù†ÙØ³ Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ØŸ (Ù„Ø¹Ù…Ù„ RowSpan)
                let isSameHospital = (nextRow && row.name === nextRow.name);
                
                // --- Ø±Ø³Ù… Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ (Ø·Ø¨ÙŠ Ø¹Ø§Ø¯Ø©) ---
                const tr1 = document.createElement('tr');
                
                // Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ (ÙŠØ¯Ù…Ø¬ ØµÙÙŠÙ† Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ ØµÙ ØªØ§Ù„Ù Ù„Ù†ÙØ³ Ø§Ù„Ø§Ø³Ù…)
                if (isSameHospital) {
                    tr1.innerHTML += `<td rowspan="2" class="sticky-col-1" style="background-color: #fcfcfc;">${row.name}</td>`;
                } else {
                    // ÙÙŠ Ø­Ø§Ù„ ÙƒØ§Ù† ØµÙ ÙˆØ§Ø­Ø¯ (Ù†Ø§Ø¯Ø± Ø§Ù„Ø­Ø¯ÙˆØ« Ù…Ø¹ Ø§Ù„Ù‡ÙŠÙƒÙ„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„ÙƒÙ† Ù„Ù„Ø§Ø­ØªÙŠØ§Ø·)
                    tr1.innerHTML += `<td class="sticky-col-1">${row.name}</td>`;
                }

                // Ø¨Ù‚ÙŠØ© Ø®Ù„Ø§ÙŠØ§ Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„
                appendRowData(tr1, row, i);
                tbody.appendChild(tr1);

                // --- Ø±Ø³Ù… Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ (ØºÙŠØ± Ø·Ø¨ÙŠ) Ø¥Ø°Ø§ ÙˆØ¬Ø¯ ---
                if (isSameHospital) {
                    const tr2 = document.createElement('tr');
                    // Ù„Ø§ Ù†Ø¶ÙŠÙ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ Ù‡Ù†Ø§ Ù„Ø£Ù†Ù‡ Ù…Ø¯Ù…Ø¬ Ù…Ø¹ Ø§Ù„Ø³Ø§Ø¨Ù‚
                    appendRowData(tr2, nextRow, i+1);
                    tr2.classList.add("hospital-separator"); // Ø®Ø· ÙØ§ØµÙ„ Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰
                    tbody.appendChild(tr2);
                    i += 2; // Ù‚ÙØ²Ù†Ø§ ØµÙÙŠÙ†
                } else {
                    tr1.classList.add("hospital-separator");
                    i++;
                }
            }
        }
    }

    function appendRowData(tr, row, rowIndex) {
        // Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯
        let typeClass = row.type === "Ø·Ø¨ÙŠ" ? "type-medical" : "type-non-medical";
        tr.innerHTML += `<td class="sticky-col-2 ${typeClass}">${row.type}</td>`;

        // Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ (Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„)
        tr.innerHTML += `<td class="sticky-col-3 editable" onclick="editCell(${rowIndex}, 'cont')">${row.cont}</td>`;
        
        // Ø§Ù„Ù…ØªØ£Ø®Ø±Ø© (Ø­Ø³Ø§Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠ)
        let autoLateCount = row.months.filter(m => m.includes('âœ˜')).length;
        row.late = autoLateCount;
        let badgeClass = row.late > 0 ? 'badge-red' : 'badge-green';
        tr.innerHTML += `<td><span class="badge ${badgeClass}">${row.late}</span></td>`;

        // Ø§Ù„Ø´Ù‡ÙˆØ±
        row.months.forEach((status, monthIndex) => {
            let statusClass = status.includes('âœ”') ? 'status-ok' : 'status-late';
            tr.innerHTML += `<td class="editable ${statusClass}" 
                                 ondblclick="toggleStatus(${rowIndex}, ${monthIndex})"
                                 onclick="editMonthText(${rowIndex}, ${monthIndex})">
                                 ${status}
                             </td>`;
        });

        // Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª
        tr.innerHTML += `<td class="editable note-text" onclick="editCell(${rowIndex}, 'notes')">${row.notes}</td>`;
    }

    window.editHeader = function(index) {
        if (!window.isAdmin) return;
        let oldVal = window.currentData.monthNames[index];
        let newVal = prompt("ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ø´Ù‡Ø±:", oldVal);
        if (newVal !== null) {
            window.currentData.monthNames[index] = newVal;
            renderTable(window.currentData);
        }
    };

    window.editCell = function(rowIndex, field) {
        if (!window.isAdmin) return;
        let oldVal = window.currentData.rows[rowIndex][field];
        let newVal = prompt("ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‚ÙŠÙ…Ø©:", oldVal);
        if (newVal !== null) {
            window.currentData.rows[rowIndex][field] = newVal;
            renderTable(window.currentData);
        }
    };

    window.editMonthText = function(rowIndex, monthIndex) { }

    window.toggleStatus = function(rowIndex, monthIndex) {
        if (!window.isAdmin) return;
        let currentStatus = window.currentData.rows[rowIndex].months[monthIndex];
        if (currentStatus.includes('âœ”')) {
            window.currentData.rows[rowIndex].months[monthIndex] = 'âœ˜';
        } else {
            window.currentData.rows[rowIndex].months[monthIndex] = 'âœ”';
        }
        renderTable(window.currentData);
    };
</script>

</body>
</html>
